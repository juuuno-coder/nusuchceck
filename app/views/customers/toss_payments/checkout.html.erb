<% content_for :title, "#{@order_name} ê²°ì œ" %>

<!-- í† ìŠ¤í˜ì´ë¨¼ì¸  JS SDK v2 -->
<script src="https://js.tosspayments.com/v2/standard"></script>

<div class="max-w-xl mx-auto py-8 px-4">
  <!-- í—¤ë” -->
  <div class="mb-6">
    <%= link_to customers_request_path(@request), class: "text-sm text-blue-600 hover:text-blue-800 flex items-center mb-3" do %>
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      ëŒì•„ê°€ê¸°
    <% end %>
    <h1 class="text-2xl font-bold text-gray-900"><%= @order_name %></h1>
    <p class="text-gray-600 mt-1">ì•ˆì „í•œ ì—ìŠ¤í¬ë¡œ ê²°ì œë¡œ ì§„í–‰ë©ë‹ˆë‹¤</p>
  </div>

  <!-- ê²°ì œ ì •ë³´ ìš”ì•½ -->
  <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
    <div class="flex justify-between items-center mb-2">
      <span class="text-sm text-gray-600">ì²´í¬ ë²ˆí˜¸</span>
      <span class="text-sm font-mono font-medium text-gray-900">#<%= @request.id %></span>
    </div>
    <div class="flex justify-between items-center mb-2">
      <span class="text-sm text-gray-600">ê²°ì œ í•­ëª©</span>
      <span class="text-sm font-medium text-gray-900"><%= @order_name %></span>
    </div>
    <div class="flex justify-between items-center pt-2 border-t border-blue-200">
      <span class="font-semibold text-gray-900">ê²°ì œ ê¸ˆì•¡</span>
      <span class="text-xl font-bold text-blue-700">
        <%= number_to_currency(@amount, unit: "â‚©", precision: 0) %>
      </span>
    </div>
  </div>

  <!-- ì—ìŠ¤í¬ë¡œ ì•ˆë‚´ -->
  <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
    <p class="text-sm font-semibold text-green-800 mb-1">ğŸ”’ ì•ˆì „í•œ ì—ìŠ¤í¬ë¡œ ê²°ì œ</p>
    <p class="text-xs text-green-700 leading-relaxed">
      ê²°ì œí•˜ì‹  ê¸ˆì•¡ì€ ì—ìŠ¤í¬ë¡œì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.
      ì„œë¹„ìŠ¤ ì™„ë£Œ í™•ì¸ í›„ ì „ë¬¸ê°€ì—ê²Œ ì§€ê¸‰ë˜ë©°, ë¬¸ì œê°€ ìƒê¸°ë©´ ì „ì•¡ í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </p>
  </div>

  <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ìœ„ì ¯ ì˜ì—­ -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-4">
    <div id="payment-method" class="mb-4"></div>
    <div id="agreement" class="mb-4"></div>
  </div>

  <!-- ê²°ì œ ë²„íŠ¼ -->
  <button
    id="payment-button"
    class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg rounded-xl transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
    disabled
  >
    <span id="payment-button-text">ê²°ì œ ìˆ˜ë‹¨ ë¡œë”© ì¤‘...</span>
  </button>

  <p class="text-center text-xs text-gray-400 mt-3">
    ê²°ì œëŠ” í† ìŠ¤í˜ì´ë¨¼ì¸ ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤
  </p>
</div>

<script>
  (async function() {
    const clientKey  = "<%= @toss_client_key %>";
    const customerKey = "user-<%= current_user.id %>";
    const amount     = <%= @amount.to_i %>;
    const orderId    = "<%= @order_id %>";
    const orderName  = "<%= @order_name %>";
    const successUrl = "<%= @success_url %>";
    const failUrl    = "<%= @fail_url %>";

    const button       = document.getElementById("payment-button");
    const buttonText   = document.getElementById("payment-button-text");

    try {
      const tossPayments = TossPayments(clientKey);
      const widgets = tossPayments.widgets({ customerKey });

      await widgets.setAmount({ currency: "KRW", value: amount });

      await Promise.all([
        widgets.renderPaymentMethods({
          selector: "#payment-method",
          variantKey: "DEFAULT"
        }),
        widgets.renderAgreement({
          selector: "#agreement",
          variantKey: "AGREEMENT"
        })
      ]);

      button.disabled = false;
      buttonText.textContent = `${amount.toLocaleString()}ì› ê²°ì œí•˜ê¸°`;

      button.addEventListener("click", async () => {
        button.disabled = true;
        buttonText.textContent = "ê²°ì œ ì²˜ë¦¬ ì¤‘...";

        try {
          await widgets.requestPayment({
            orderId,
            orderName,
            successUrl,
            failUrl,
            customerEmail: "<%= current_user.email %>",
            customerName:  "<%= current_user.name %>",
          });
        } catch (error) {
          // ì‚¬ìš©ìê°€ ê²°ì œì°½ì„ ë‹«ê±°ë‚˜ ì·¨ì†Œí•œ ê²½ìš°
          button.disabled = false;
          buttonText.textContent = `${amount.toLocaleString()}ì› ê²°ì œí•˜ê¸°`;
          if (error.code !== "USER_CANCEL") {
            console.error("ê²°ì œ ì˜¤ë¥˜:", error);
          }
        }
      });

    } catch (error) {
      console.error("í† ìŠ¤ ìœ„ì ¯ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
      buttonText.textContent = "ê²°ì œ ìœ„ì ¯ ë¡œë“œ ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”";
    }
  })();
</script>

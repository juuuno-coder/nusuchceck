<div class="max-w-3xl mx-auto">
  <%= render "shared/page_header",
      title: "견적서 ##{@estimate.id}",
      back_path: customers_request_path(@estimate.request),
      back_text: "신고 상세로 돌아가기" %>

  <div class="flex items-center justify-end mb-4">
    <%
      estimate_badge = case @estimate.status
        when "pending"  then "bg-yellow-100 text-yellow-800"
        when "accepted" then "bg-green-100 text-green-800"
        when "rejected" then "bg-red-100 text-red-800"
        when "expired"  then "bg-gray-100 text-gray-800"
        else "bg-gray-100 text-gray-800"
      end
    %>
    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= estimate_badge %>" role="status">
      <%= @estimate.status_label %>
    </span>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-6">
    <!-- 기본 정보 -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
      <div>
        <dt class="font-medium text-gray-500">신고 번호</dt>
        <dd class="mt-1 text-gray-900">#<%= @estimate.request_id %></dd>
      </div>
      <div>
        <dt class="font-medium text-gray-500">작성 마스터</dt>
        <dd class="mt-1 text-gray-900"><%= @estimate.master&.name %></dd>
      </div>
      <div>
        <dt class="font-medium text-gray-500">작성일</dt>
        <dd class="mt-1 text-gray-900"><%= @estimate.created_at.strftime("%Y-%m-%d") %></dd>
      </div>
      <% if @estimate.respond_to?(:valid_until) && @estimate.valid_until.present? %>
        <div>
          <dt class="font-medium text-gray-500">유효기간</dt>
          <dd class="mt-1 text-gray-900"><%= @estimate.valid_until.strftime("%Y-%m-%d") %></dd>
        </div>
      <% end %>
    </div>

    <!-- 견적 항목 테이블 -->
    <% if @estimate.parsed_line_items.any? %>
      <%
        category_labels = { "trip" => "출장비", "detection" => "탐지", "construction" => "공사", "material" => "자재" }
      %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" aria-label="견적 항목 목록">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">구분</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">항목명</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">단위</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">수량</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">단가</th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">금액</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <% @estimate.parsed_line_items.each do |item| %>
              <tr>
                <td class="px-4 py-3 text-sm text-gray-600"><%= category_labels[item[:category]] || item[:category] %></td>
                <td class="px-4 py-3 text-sm text-gray-900"><%= item[:name] %></td>
                <td class="px-4 py-3 text-sm text-gray-600"><%= item[:unit] %></td>
                <td class="px-4 py-3 text-sm text-right text-gray-600"><%= item[:quantity] %></td>
                <td class="px-4 py-3 text-sm text-right text-gray-600"><%= number_to_currency(item[:unit_price], unit: "₩", precision: 0) %></td>
                <td class="px-4 py-3 text-sm text-right font-medium text-gray-900"><%= number_to_currency(item[:amount], unit: "₩", precision: 0) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <!-- 합계 -->
    <div class="border-t pt-4">
      <div class="flex flex-col items-end space-y-2 text-sm">
        <div class="flex justify-between w-64">
          <span class="text-gray-500">소계</span>
          <span class="font-medium text-gray-900"><%= number_to_currency(@estimate.total_amount.to_d - @estimate.vat.to_d, unit: "₩", precision: 0) %></span>
        </div>
        <div class="flex justify-between w-64">
          <span class="text-gray-500">부가세 (10%)</span>
          <span class="font-medium text-gray-900"><%= number_to_currency(@estimate.vat, unit: "₩", precision: 0) %></span>
        </div>
        <div class="flex justify-between w-64 pt-2 border-t-2 border-gray-300 text-base">
          <span class="font-bold text-gray-900">총액</span>
          <span class="font-bold text-blue-600"><%= number_to_currency(@estimate.total_amount, unit: "₩", precision: 0) %></span>
        </div>
      </div>
    </div>

    <!-- 비고 -->
    <% if @estimate.respond_to?(:notes) && @estimate.notes.present? %>
      <div class="border-t pt-4">
        <h3 class="text-sm font-medium text-gray-500 mb-2">비고</h3>
        <p class="text-sm text-gray-700 whitespace-pre-wrap"><%= @estimate.notes %></p>
      </div>
    <% end %>
  </div>
</div>

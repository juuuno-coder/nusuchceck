<div class="space-y-6">
  <!-- 뒤로가기 + 헤더 -->
  <div class="flex items-center justify-between">
    <div>
      <%= link_to admin_requests_path, class: "text-sm text-blue-600 hover:text-blue-800 flex items-center" do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        목록으로
      <% end %>
      <h1 class="text-2xl font-bold text-gray-900 mt-2">신고 #<%= @request.id %> (관리자)</h1>
    </div>
    <div>
      <%= render "shared/status_badge", status: @request.status %>
    </div>
  </div>

  <!-- 상태 타임라인 -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <%= render "shared/status_timeline", request_record: @request %>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 좌측: 정보 -->
    <div class="lg:col-span-2 space-y-6">
      <!-- 기본 정보 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">기본 정보</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">고객</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.customer&.name || "-" %> (<%= @request.customer&.email %>)</dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">마스터</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.master&.name || "미배정" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">증상 유형</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= symptom_label(@request.symptom_type) %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">건물 유형</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= building_label(@request.building_type) || "-" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">주소</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.address %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">상세 주소 / 층수</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= [@request.detailed_address, @request.floor_info].compact_blank.join(" / ").presence || "-" %></dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">상세 설명</dt>
            <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap"><%= @request.description.presence || "-" %></dd>
          </div>
        </dl>

        <% if @request.photos.attached? %>
          <div class="mt-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3">첨부 사진</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <% @request.photos.each do |photo| %>
                <div class="aspect-square rounded-lg overflow-hidden bg-gray-100">
                  <%= image_tag photo, class: "w-full h-full object-cover" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 견적 정보 -->
      <% if @request.estimates.any? %>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">견적 목록</h2>
          <% @request.estimates.recent.each do |estimate| %>
            <div class="border rounded-lg p-4 mb-3 last:mb-0">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium text-gray-900">견적 #<%= estimate.id %></span>
                <div class="flex items-center gap-2">
                  <span class="text-lg font-semibold text-blue-600"><%= number_to_currency(estimate.total_amount, unit: "₩", precision: 0) %></span>
                  <%
                    est_badge = case estimate.status
                      when "pending"  then "bg-yellow-100 text-yellow-800"
                      when "accepted" then "bg-green-100 text-green-800"
                      when "rejected" then "bg-red-100 text-red-800"
                      else "bg-gray-100 text-gray-800"
                    end
                  %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= est_badge %>" role="status"><%= estimate.status_label %></span>
                </div>
              </div>
              <p class="text-sm text-gray-500">작성: <%= estimate.master&.name %> | <%= estimate.created_at.strftime("%Y-%m-%d %H:%M") %></p>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- 단계별 에스크로 -->
      <% if @request.escrow_transactions.any? %>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">에스크로 거래 내역</h2>
          <div class="space-y-3">
            <% @request.escrow_transactions.each do |escrow| %>
              <div class="border rounded-lg p-3">
                <div class="flex items-center justify-between mb-1">
                  <span class="font-medium text-sm text-gray-800">
                    <%= { "trip" => "🚗 출장비", "detection" => "🔍 검사비", "construction" => "🔧 공사비" }[escrow.escrow_type] || escrow.escrow_type %>
                  </span>
                  <%= render "shared/status_badge", status: escrow.status %>
                </div>
                <div class="grid grid-cols-3 gap-2 text-xs text-gray-600">
                  <div>결제: <span class="font-medium text-gray-900"><%= number_to_currency(escrow.amount, unit: "₩", precision: 0) %></span></div>
                  <div>수수료: <span class="text-red-600">-<%= number_to_currency(escrow.platform_fee, unit: "₩", precision: 0) %></span></div>
                  <div>지급액: <span class="font-medium text-green-700"><%= number_to_currency(escrow.master_payout, unit: "₩", precision: 0) %></span></div>
                </div>
              </div>
            <% end %>
            <div class="pt-2 border-t flex justify-between text-sm font-medium">
              <span class="text-gray-600">총 결제</span>
              <span class="text-blue-600"><%= number_to_currency(@request.escrow_transactions.sum(:amount), unit: "₩", precision: 0) %></span>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 우측: 관리 액션 -->
    <div class="space-y-6">
      <!-- 오더 배정 (공개 등록 / 직접 배정) -->
      <% if @request.reported? || @request.open? %>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">오더 배정</h2>

          <% if @request.reported? %>
            <!-- 공개 등록 (권장) -->
            <div class="mb-4 p-3 bg-emerald-50 rounded-lg border border-emerald-100">
              <p class="text-sm text-emerald-700 font-medium mb-2">공개 오더 풀에 등록 (권장)</p>
              <p class="text-xs text-emerald-600 mb-3">검증된 전문가들이 선착순으로 선택할 수 있습니다</p>
              <%= button_to "공개 등록",
                    publish_admin_request_path(@request),
                    method: :post,
                    class: "#{btn_classes(:success, :md)} w-full",
                    data: { turbo_confirm: "공개 오더 풀에 등록하시겠습니까?" } %>
            </div>

            <div class="relative flex items-center my-4">
              <div class="flex-grow border-t border-gray-200"></div>
              <span class="flex-shrink mx-3 text-xs text-gray-400">또는 직접 배정</span>
              <div class="flex-grow border-t border-gray-200"></div>
            </div>
          <% end %>

          <% if @request.reported? || @request.open? %>
            <!-- 직접 배정 (수동 오버라이드) -->
            <%= form_with url: assign_master_admin_request_path(@request), method: :post, class: "space-y-3" do |f| %>
              <%= f.select :master_id,
                    options_for_select(
                      @available_masters.map { |m| ["#{m.name} (평점 #{m.average_rating})", m.id] }
                    ),
                    { prompt: "마스터 선택" },
                    class: input_classes(:select) %>
              <%= f.submit "직접 배정",
                    class: "#{btn_classes(:primary, :md)} w-full",
                    data: { turbo_confirm: "이 마스터를 직접 배정하시겠습니까?" } %>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <!-- 공개 오더 대기 중 안내 -->
      <% if @request.open? %>
        <div class="bg-blue-50 rounded-xl border border-blue-100 p-4">
          <div class="flex items-center text-blue-700 mb-1">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-sm font-semibold">공개 오더 풀 등록됨</span>
          </div>
          <p class="text-xs text-blue-600">전문가들이 선착순으로 선택 중입니다</p>
        </div>
      <% end %>

      <!-- 관리 작업 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">관리 작업</h2>
        <div class="space-y-3">
          <% if @request.no_leak_found? %>
            <%= button_to "비용 미청구 종료",
                  close_no_charge_admin_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:secondary, :md)} w-full",
                  data: { turbo_confirm: "비용 미청구로 종료하시겠습니까?" } %>
          <% end %>

          <% if @request.construction_completed? %>
            <%= button_to "최종 종료 (관리자)",
                  finalize_admin_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:success, :md)} w-full",
                  data: { turbo_confirm: "이 신고를 최종 종료하시겠습니까?" } %>
          <% end %>

          <% if @request.status.in?(%w[closed cancelled]) %>
            <p class="text-sm text-gray-500 text-center">이 신고는 이미 종료/취소 되었습니다.</p>
          <% end %>
        </div>
      </div>

      <!-- 하자보수 보증기간 설정 -->
      <% if @request.closed? %>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">하자보수 보증</h2>
          <% if @request.warranty_expires_at.present? %>
            <div class="p-3 bg-orange-50 rounded-lg border border-orange-100 mb-3">
              <p class="text-sm font-medium text-orange-800">보증기간: <%= @request.warranty_period_months %>개월</p>
              <p class="text-xs text-orange-600">만료: <%= @request.warranty_expires_at.strftime("%Y년 %m월 %d일") %></p>
              <% if @request.under_warranty? %>
                <span class="inline-block mt-1 text-xs font-bold text-green-600">✓ 보증 유효</span>
              <% else %>
                <span class="inline-block mt-1 text-xs font-bold text-red-600">✗ 보증 만료</span>
              <% end %>
            </div>
          <% end %>

          <%= form_with url: set_warranty_admin_request_path(@request), method: :post, class: "flex gap-2" do |f| %>
            <%= f.number_field :warranty_months, min: 0, max: 24, placeholder: "개월",
                  class: "flex-1 #{input_classes(:text)}" %>
            <%= f.submit "보증 설정",
                  class: "#{btn_classes(:warning, :sm)} whitespace-nowrap" %>
          <% end %>
        </div>

        <!-- 고객 불만 CS -->
        <% if @request.has_complaint? %>
          <div class="bg-red-50 rounded-xl shadow-sm border border-red-200 p-6">
            <h2 class="text-lg font-semibold text-red-900 mb-3">🚨 고객 불만 접수</h2>
            <div class="bg-white rounded-lg p-3 mb-3 border border-red-100">
              <p class="text-sm text-gray-800 whitespace-pre-wrap"><%= @request.customer_complaint %></p>
              <p class="text-xs text-gray-400 mt-2">접수일: <%= @request.complaint_submitted_at&.strftime("%Y-%m-%d %H:%M") %></p>
            </div>
            <%= button_to "처리 완료",
                  resolve_complaint_admin_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:danger, :sm)} w-full",
                  data: { turbo_confirm: "고객 불만을 처리 완료로 표시하시겠습니까?" } %>
          </div>
        <% end %>
      <% end %>

      <!-- 일시 정보 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">일시 기록</h2>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">접수일</dt>
            <dd class="text-gray-900"><%= @request.created_at.strftime("%Y-%m-%d %H:%M") %></dd>
          </div>
          <% if @request.assigned_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">배정일</dt>
              <dd class="text-gray-900"><%= @request.assigned_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.visit_started_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">방문 시작</dt>
              <dd class="text-gray-900"><%= @request.visit_started_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.detection_started_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">탐지 시작</dt>
              <dd class="text-gray-900"><%= @request.detection_started_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.construction_started_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">공사 시작</dt>
              <dd class="text-gray-900"><%= @request.construction_started_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.construction_completed_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">공사 완료</dt>
              <dd class="text-gray-900"><%= @request.construction_completed_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.closed_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">종료일</dt>
              <dd class="text-gray-900"><%= @request.closed_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  </div>
</div>

<%# 상태 타임라인 - request_record 변수를 받아서 진행 상태 시각적으로 표시 %>
<%
  all_steps = [
    { key: "reported",               label: "접수" },
    { key: "assigned",               label: "배정" },
    { key: "visiting",               label: "방문" },
    { key: "detecting",              label: "탐지" },
    { key: "estimate_pending",       label: "견적 대기" },
    { key: "estimate_submitted",     label: "견적 제출" },
    { key: "construction_agreed",    label: "합의" },
    { key: "escrow_deposited",       label: "입금" },
    { key: "constructing",           label: "공사" },
    { key: "construction_completed", label: "공사 완료" },
    { key: "closed",                 label: "종료" }
  ]

  current_status = request_record.status.to_s

  # 취소/누수미확인 등 특수 상태 처리
  if current_status == "cancelled"
    cancelled = true
  elsif current_status == "no_leak_found"
    no_leak = true
  end

  current_index = all_steps.index { |s| s[:key] == current_status } || -1
%>
<div class="mb-6" role="progressbar" aria-label="신고 진행 상태" aria-valuenow="<%= current_index + 1 %>" aria-valuemin="1" aria-valuemax="<%= all_steps.size %>">
  <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">진행 상태</h3>

  <% if local_assigns[:cancelled] || cancelled %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center" role="alert">
      <span class="text-red-600 font-semibold">이 신고는 취소되었습니다.</span>
    </div>
  <% elsif local_assigns[:no_leak] || no_leak %>
    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center" role="alert">
      <span class="text-gray-600 font-semibold">누수가 확인되지 않았습니다.</span>
    </div>
  <% else %>
    <div class="flex items-center overflow-x-auto pb-2">
      <% all_steps.each_with_index do |step, index| %>
        <%
          if index < current_index
            step_class = "text-green-600"
            circle_class = "bg-green-500 text-white"
            line_class = "bg-green-500"
          elsif index == current_index
            step_class = "text-blue-600 font-semibold"
            circle_class = "bg-blue-500 text-white ring-4 ring-blue-200"
            line_class = "bg-gray-300"
          else
            step_class = "text-gray-500"
            circle_class = "bg-gray-300 text-white"
            line_class = "bg-gray-300"
          end
        %>
        <div class="flex items-center flex-shrink-0">
          <div class="flex flex-col items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold <%= circle_class %>">
              <% if index < current_index %>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>
              <% else %>
                <%= index + 1 %>
              <% end %>
            </div>
            <span class="text-xs mt-1 whitespace-nowrap <%= step_class %>"><%= step[:label] %></span>
          </div>
          <% unless index == all_steps.size - 1 %>
            <div class="w-8 h-0.5 mx-1 mt-[-12px] <%= line_class %>" aria-hidden="true"></div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

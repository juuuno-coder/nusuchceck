# 누수체크 MVP 프로젝트 초기 구현 세션 로그

**날짜**: 2026년 2월 12일
**프로젝트**: 누수체크 - Ruby on Rails MVP
**작업 환경**: Windows 11 Pro, D:\dev\nusucheck

---

## 1. 세션 목표

누수 시장의 불투명성을 해결하는 매칭 플랫폼 "누수체크"를 Ruby on Rails 7.1로 구축.
핵심 가치: 3단계 정산 시스템, 에스크로 대금 예치, 보험 서류 자동화, 마스터 검증제.

---

## 2. WSL2 환경 설정 시도

### 2.1 현황
- WSL2가 설치되어 있지 않은 상태에서 시작
- `wsl --install -d Ubuntu-22.04` 실행 시도
- 관리자 권한으로 PowerShell 실행하여 WSL2 기능 활성화 시도

### 2.2 결과
- WSL2 **기능 자체는 활성화**되었으나, Ubuntu 배포판 다운로드가 완료되지 않음
- 원인: WSL2 기능 최초 활성화 후 **시스템 재시작이 필요**한 상태
- **결정**: 파일 먼저 생성 후, 재부팅 후에 Ubuntu 설치 및 환경 세팅 진행하기로 함

---

## 3. Rails 프로젝트 파일 생성 (총 122개 파일)

WSL2 없이 `D:\dev\nusucheck`에 전체 Rails 프로젝트 구조를 수동으로 생성함.

### 3.1 프로젝트 설정 (16개 파일)

| 파일 | 설명 |
|------|------|
| `Gemfile` | devise, pundit, aasm, prawn, sidekiq, kaminari, ransack, geocoder 등 핵심 Gem |
| `config/database.yml` | PostgreSQL 설정 (development/test/production) |
| `config/application.rb` | Rails 7.1 설정, 시간대 Seoul, 로케일 ko |
| `config/routes.rb` | 3개 네임스페이스 (customers/masters/admin) + API + PDF 다운로드 |
| `config/environments/` | development, production, test 환경별 설정 |
| `config/initializers/` | devise, sidekiq, kaminari, geocoder, inflections, pundit |
| `config/locales/ko.yml` | 한국어 번역 (모델명, 속성명, enum 라벨, 날짜/통화 포맷) |
| `config/importmap.rb` | Hotwire (Turbo + Stimulus) 임포트맵 |
| `config/storage.yml` | Active Storage 디스크 설정 |
| `config/cable.yml` | ActionCable Redis 설정 |
| `config/puma.rb` | Puma 웹서버 설정 |

### 3.2 데이터베이스 마이그레이션 (7개 파일)

| # | 마이그레이션 | 주요 컬럼 |
|---|-------------|-----------|
| 1 | `devise_create_users` | STI(type), Devise 인증, name, phone, address, 좌표, role |
| 2 | `create_master_profiles` | user_id(unique), 자격증, 장비(JSONB), 서비스지역(배열), 계좌정보, verified |
| 3 | `create_requests` | customer/master 참조, status(AASM), symptom_type(6종), building_type(7종), 주소/좌표, 6개 타임스탬프, 탐지결과, 비용 4종 |
| 4 | `create_estimates` | request/master 참조, line_items(JSONB), 소계 3종, VAT, 총액, status |
| 5 | `create_escrow_transactions` | request(unique)/customer/master 참조, 금액, 수수료(5%), 정산금, PG거래ID, status(7종) |
| 6 | `create_reviews` | request(unique)/customer/master 참조, 총점, 세부 5개 평점 |
| 7 | `create_standard_estimate_items` | category, name, 가격 3종, recommended_for(배열), sort_order |

### 3.3 모델 (8개 파일)

| 모델 | 핵심 기능 |
|------|-----------|
| `User` (STI) | Devise 인증, geocoder, role enum (user/admin) |
| `Customer` < User | has_many requests, reviews, escrow_transactions |
| `Master` < User | has_one master_profile, has_many assigned_requests, average_rating 계산 |
| `MasterProfile` | 자격증, 장비(JSONB), 서비스지역(배열), 인증 관리 (verify!/reject!) |
| `Request` | **AASM 13개 상태, 15+ 전이**, 가드 조건 (master_present?, leak_confirmed?, escrow_deposited?) |
| `Estimate` | line_items JSONB 파싱, 자동 소계/VAT/총액 계산, accept!/reject!/expire! |
| `EscrowTransaction` | **AASM 7개 상태**, 5% 수수료 자동 계산, deposit/release/refund/settle |
| `Review` | 5개 세부 평점, overall_rating 자동 계산 |
| `StandardEstimateItem` | 카테고리별 표준 견적 항목, 증상별 추천 매핑 |

### 3.4 AASM 상태머신 상세

#### Request 상태 (13개)
```
reported → assigned → visiting → detecting
                                    ├→ no_leak_found → closed (비용미청구)
                                    └→ estimate_pending → estimate_submitted → construction_agreed
                                        → escrow_deposited → constructing → construction_completed → closed
어디서든 → cancelled (공사 진행 전 단계에서만)
```

#### EscrowTransaction 상태 (7개)
```
pending → deposited → released → settled
                   ↘ held ↗
          deposited/held → refunded
          deposited/held → disputed
```

### 3.5 컨트롤러 (12개 파일)

| 네임스페이스 | 컨트롤러 | 주요 액션 |
|-------------|---------|-----------|
| **고객** | Customers::RequestsController | index, show, new, create, cancel, accept_estimate, deposit_escrow, confirm_completion |
| **고객** | Customers::ReviewsController | new, create |
| **고객** | Customers::EstimatesController | show |
| **마스터** | Masters::RequestsController | index, show, visit, arrive, detection_complete, detection_fail, submit_estimate, start_construction, complete_construction |
| **마스터** | Masters::EstimatesController | new, create, edit, update |
| **마스터** | Masters::ProfilesController | show, edit, update |
| **관리자** | Admin::DashboardController | index (통계 대시보드) |
| **관리자** | Admin::RequestsController | index, show, assign_master, close_no_charge, finalize |
| **관리자** | Admin::MastersController | index, show, verify, reject |
| **관리자** | Admin::EscrowTransactionsController | index, show, release_payment, refund |
| **API** | Api::StandardEstimateItemsController | index (JSON, 증상/카테고리 필터) |
| **PDF** | RequestsController | insurance_report_pdf, estimate_pdf, completion_report_pdf |

### 3.6 Pundit 정책 (4개 파일)

| 정책 | 주요 로직 |
|------|-----------|
| `RequestPolicy` | 고객=본인신고만, 마스터=배정된신고만, 관리자=전체, 상태별 액션 권한 |
| `EstimatePolicy` | 고객=본인견적만, 마스터=본인작성만, 수락/거절 권한 |
| `EscrowTransactionPolicy` | 관리자만 목록/지급/환불, 당사자는 조회만 |

### 3.7 서비스 객체 (3개 파일)

| 서비스 | 역할 |
|--------|------|
| `EscrowService` | 에스크로 생성/입금, 대금 지급, 환불 처리 (트랜잭션 보장, PG 시뮬레이션) |
| `EstimateCalculator` | 증상별 추천 항목, 가격대 조회, 라인아이템 자동 생성, 총액 계산 |
| `PdfGeneratorService` | 보험보고서/견적서/완료보고서 3종 PDF (Prawn, 한글폰트 지원) |

### 3.8 뷰 (22개 파일)

| 구분 | 파일 수 | 내용 |
|------|---------|------|
| 레이아웃 | 3개 | 네비게이션(역할별), 플래시메시지, 푸터 |
| 공개 페이지 | 2개 | 홈(히어로+3단계+장점), 소개(에스크로설명) |
| Devise | 3개 | 회원가입(유형선택), 로그인, 공유링크 |
| 고객 뷰 | 5개 | 신고목록/상세/작성, 리뷰작성, 견적상세 |
| 마스터 뷰 | 6개 | 신고목록/상세, 견적작성/수정, 프로필보기/수정 |
| 관리자 뷰 | 7개 | 대시보드, 신고관리(목록/상세), 마스터관리(목록/상세), 에스크로(목록/상세) |
| 공유 파셜 | 2개 | 상태 뱃지(13종 컬러), 상태 타임라인 |

### 3.9 JavaScript - Stimulus 컨트롤러 (3개)

| 컨트롤러 | 기능 |
|---------|------|
| `estimate_items_controller.js` | 견적 항목 동적 추가/삭제, 자동 금액 계산, API로 추천 항목 로드 |
| `dismissible_controller.js` | 플래시 메시지 클릭/5초 자동 닫기 |
| `star_rating_controller.js` | 리뷰 별점 인터랙션 (클릭으로 별 채우기) |

### 3.10 테스트 (8개 파일)

| 구분 | 파일 | 내용 |
|------|------|------|
| 설정 | spec_helper.rb, rails_helper.rb | RSpec + FactoryBot + Shoulda + Devise 통합 |
| 팩토리 | 5개 | users, requests, estimates, escrow_transactions, reviews |
| 모델 스펙 | request_spec.rb | AASM 전체 워크플로우 테스트 (happy path 포함) |
| 모델 스펙 | escrow_transaction_spec.rb | AASM 상태 전이, 수수료 계산 테스트 |
| 서비스 스펙 | escrow_service_spec.rb | 입금/지급/환불 시나리오 테스트 |

### 3.11 Seed 데이터

- **표준 견적 항목 22개**: 출장비(1), 탐지(5), 공사(10), 자재(6)
- **데모 계정 6개**: 관리자 1, 고객 2, 마스터 3 (인증 2, 미인증 1)
- **데모 신고 3건**: 배정됨(1), 탐지완료(1), 전체완료+리뷰(1)

---

## 4. 다음 단계 (재부팅 후)

### 4.1 WSL2 환경 완성
```bash
# 1. Ubuntu 설치
wsl --install Ubuntu-22.04

# 2. 환경 셋업 스크립트 실행
bash bin/wsl_setup.sh
```

### 4.2 프로젝트 실행
```bash
# WSL 내부로 복사
cp -r /mnt/d/dev/nusucheck ~/projects/nusucheck
cd ~/projects/nusucheck

# 의존성 및 DB
bundle install
bin/rails db:create
bin/rails db:migrate
bin/rails db:seed

# 서버 실행
bin/rails server
```

### 4.3 검증 항목
1. `bin/rails db:migrate` → 마이그레이션 오류 없이 완료
2. `bin/rails db:seed` → Seed 데이터 정상 입력
3. Rails 콘솔에서 AASM 상태 전이 테스트
4. 브라우저에서 회원가입/로그인/신고 플로우 확인
5. PDF 다운로드 및 한글 깨짐 확인
6. `bundle exec rspec` → 모델/서비스 단위 테스트 통과

---

## 5. 데모 계정 정보

| 역할 | 이메일 | 비밀번호 | 비고 |
|------|--------|----------|------|
| 관리자 | admin@nusucheck.kr | password123 | |
| 고객1 | customer@example.com | password123 | 김철수 |
| 고객2 | customer2@example.com | password123 | 이영희 |
| 마스터1 | master@example.com | password123 | 박누수, 인증됨, 8년 경력 |
| 마스터2 | master2@example.com | password123 | 최배관, 인증됨, 5년 경력 |
| 마스터3 | master3@example.com | password123 | 정미인증, 미인증 |

---

## 6. 프로젝트 아키텍처 결정 근거

| 결정 | 이유 |
|------|------|
| User STI 방식 | Customer/Master가 동일한 Devise 인증 공유, 추가 정보는 MasterProfile로 분리 |
| AASM 사용 | 13개 상태 + 15개 전이의 복잡한 워크플로우에서 가드/콜백/`may_xxx?` 필수 |
| 견적 항목 JSONB | 확정 후 변경 없는 스냅샷 성격, 유동적 항목 수 |
| 에스크로 별도 모델 | 결제 상태 독립 관리, 환불/정산 이력 추적, PG사 연동 시 정보 격리 |
| Prawn (PDF) | wkhtmltopdf 의존성 없음, 한글 폰트 직접 제어, 정형 문서에 적합 |
| Pundit (인가) | 역할별 권한을 정책 객체로 명확히 분리, `may_xxx?`와 결합하여 상태 기반 권한 제어 |

---

*이 세션 로그는 2026년 2월 12일 작업 내용을 기록한 것입니다.*

<div class="space-y-6">
  <!-- 뒤로가기 + 헤더 -->
  <div class="flex items-center justify-between">
    <div>
      <%= link_to masters_requests_path, class: "text-sm text-blue-600 hover:text-blue-800 flex items-center" do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        목록으로
      <% end %>
      <h1 class="text-2xl font-bold text-gray-900 mt-2">신고 #<%= @request.id %></h1>
    </div>
    <div>
      <%= render "shared/status_badge", status: @request.status %>
    </div>
  </div>

  <!-- 상태 타임라인 -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <%= render "shared/status_timeline", request_record: @request %>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 좌측: 정보 -->
    <div class="lg:col-span-2 space-y-6">
      <!-- 고객 정보 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">고객 정보</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">고객명</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.customer&.name || "-" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">연락처</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.customer&.phone || "-" %></dd>
          </div>
        </dl>
      </div>

      <!-- 증상/위치 정보 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">증상 및 위치</h2>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">증상 유형</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= symptom_label(@request.symptom_type) %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">건물 유형</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= building_label(@request.building_type) || "-" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">주소</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.address %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">상세 주소</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.address_detail.presence || "-" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">층수</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.floor.presence || "-" %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">희망 방문 일시</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @request.preferred_date&.strftime("%Y-%m-%d %H:%M") || "-" %></dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">상세 설명</dt>
            <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap"><%= @request.description.presence || "-" %></dd>
          </div>
        </dl>

        <% if @request.photos.attached? %>
          <div class="mt-6">
            <h3 class="text-sm font-medium text-gray-500 mb-3">첨부 사진</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              <% @request.photos.each do |photo| %>
                <div class="aspect-square rounded-lg overflow-hidden bg-gray-100">
                  <%= image_tag photo, class: "w-full h-full object-cover" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 견적 목록 (있을 경우) -->
      <% if @request.estimates.any? %>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">견적 목록</h2>
          <div class="space-y-3">
            <% @request.estimates.recent.each do |estimate| %>
              <div class="border rounded-lg p-4 flex items-center justify-between">
                <div>
                  <span class="font-medium text-gray-900">견적 #<%= estimate.id %></span>
                  <span class="ml-2 text-sm text-gray-500"><%= estimate.created_at.strftime("%Y-%m-%d") %></span>
                  <span class="ml-2 text-lg font-semibold text-blue-600"><%= number_to_currency(estimate.total_amount, unit: "₩", precision: 0) %></span>
                </div>
                <div class="flex items-center gap-2">
                  <%
                    est_badge = case estimate.status
                      when "pending"  then "bg-yellow-100 text-yellow-800"
                      when "accepted" then "bg-green-100 text-green-800"
                      when "rejected" then "bg-red-100 text-red-800"
                      else "bg-gray-100 text-gray-800"
                    end
                  %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= est_badge %>" role="status">
                    <%= estimate.status_label %>
                  </span>
                  <%= link_to "수정", edit_masters_request_estimate_path(@request, estimate), class: "text-sm text-blue-600 hover:text-blue-800" if estimate.pending? %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 우측: 액션 -->
    <div class="space-y-6">
      <!-- 상태별 액션 버튼들 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">작업</h2>
        <div class="space-y-3">
          <% if @request.assigned? %>
            <%= button_to "방문 시작",
                  visit_masters_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:primary, :md)} w-full",
                  data: { turbo_confirm: "방문을 시작하시겠습니까?" } %>
          <% end %>

          <% if @request.visiting? %>
            <%= button_to "현장 도착",
                  arrive_masters_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:primary, :md)} w-full",
                  data: { turbo_confirm: "현장에 도착하셨습니까?" } %>
          <% end %>

          <% if @request.detecting? %>
            <div class="space-y-3">
              <!-- 누수 확인 (detection_notes 입력) -->
              <%= form_with url: detection_complete_masters_request_path(@request), method: :post, class: "space-y-2" do |f| %>
                <%= f.text_area :detection_notes,
                      rows: 3,
                      placeholder: "탐지 결과 메모 (누수 위치, 원인 등)",
                      class: input_classes(:textarea) %>
                <%= f.submit "누수 확인 완료",
                      class: "#{btn_classes(:success, :md)} w-full",
                      data: { turbo_confirm: "누수가 확인되었습니까?" } %>
              <% end %>

              <%= button_to "누수 미확인",
                    detection_fail_masters_request_path(@request),
                    method: :post,
                    class: "#{btn_classes(:warning, :md)} w-full",
                    data: { turbo_confirm: "누수가 확인되지 않았습니까? 이 작업은 되돌릴 수 없습니다." } %>
            </div>
          <% end %>

          <% if @request.estimate_pending? %>
            <% if @request.estimates.empty? %>
              <%= link_to "견적 작성",
                    new_masters_request_estimate_path(@request),
                    class: "block w-full #{btn_classes(:primary, :md)} text-center" %>
            <% else %>
              <%= link_to "견적 추가 작성",
                    new_masters_request_estimate_path(@request),
                    class: "block w-full #{btn_classes(:outline, :md)} text-center" %>

              <%= button_to "견적 제출",
                    submit_estimate_masters_request_path(@request),
                    method: :post,
                    class: "#{btn_classes(:success, :md)} w-full",
                    data: { turbo_confirm: "견적을 고객에게 제출하시겠습니까?" } %>
            <% end %>
          <% end %>

          <% if @request.escrow_deposited? %>
            <%= button_to "공사 시작",
                  start_construction_masters_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:primary, :md)} w-full bg-purple-600 hover:bg-purple-700",
                  data: { turbo_confirm: "공사를 시작하시겠습니까?" } %>
          <% end %>

          <% if @request.constructing? %>
            <%= button_to "공사 완료",
                  complete_construction_masters_request_path(@request),
                  method: :post,
                  class: "#{btn_classes(:success, :md)} w-full",
                  data: { turbo_confirm: "공사가 완료되었습니까?" } %>
          <% end %>

          <% if @request.construction_completed? %>
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-100 mb-3">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">💼</span>
                <p class="text-sm font-semibold text-gray-900">보험청구 도움</p>
              </div>
              <p class="text-xs text-gray-700 mb-3">고객을 위해 보험청구서를 작성해드릴 수 있어요</p>
              <%= link_to "보험청구서 작성하기",
                    new_masters_request_insurance_claim_path(@request),
                    class: "block w-full text-center #{btn_classes(:primary, :md)} bg-purple-600 hover:bg-purple-700" %>
            </div>
          <% end %>

          <% if @request.status.in?(%w[closed cancelled no_leak_found estimate_submitted construction_agreed]) %>
            <p class="text-sm text-gray-500 text-center">현재 상태에서 가능한 작업이 없습니다.</p>
          <% end %>
        </div>
      </div>

      <!-- 접수 정보 -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">접수 정보</h2>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">접수번호</dt>
            <dd class="font-mono text-gray-900">#<%= @request.id %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">접수일</dt>
            <dd class="text-gray-900"><%= @request.created_at.strftime("%Y-%m-%d %H:%M") %></dd>
          </div>
          <% if @request.assigned_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">배정일</dt>
              <dd class="text-gray-900"><%= @request.assigned_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.detection_started_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">탐지 시작</dt>
              <dd class="text-gray-900"><%= @request.detection_started_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.construction_started_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">공사 시작</dt>
              <dd class="text-gray-900"><%= @request.construction_started_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
          <% if @request.construction_completed_at.present? %>
            <div class="flex justify-between">
              <dt class="text-gray-500">공사 완료</dt>
              <dd class="text-gray-900"><%= @request.construction_completed_at.strftime("%Y-%m-%d %H:%M") %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>
  </div>
</div>
